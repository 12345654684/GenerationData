{% extends 'generator/base.html' %}

{% block title %}数据库配置{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
    <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">数据库连接配置</h2>
        <p class="text-gray-600 mt-1">请输入MySQL数据库连接信息</p>
    </div>
    
    <div class="p-6">
        <form method="post" id="dbConfigForm">
            {% csrf_token %}
            
            <div class="space-y-4">
                <div>
                    <label for="host" class="block text-sm font-medium text-gray-700 mb-1">主机地址</label>
                    <input type="text" name="host" id="host" 
                           value="{{ db_config.host|default:'localhost' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                           placeholder="数据库主机地址">
                </div>
                
                <div>
                    <label for="port" class="block text-sm font-medium text-gray-700 mb-1">端口</label>
                    <input type="number" name="port" id="port" 
                           value="{{ db_config.port|default:'3306' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                           placeholder="数据库端口，默认3306">
                </div>
                
                <div>
                    <label for="user" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                    <input type="text" name="user" id="user" 
                           value="{{ db_config.user|default:'root' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                           placeholder="数据库用户名">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" name="password" id="password" 
                           value="{{ db_config.password|default:'' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                           placeholder="数据库密码">
                </div>
                
                <div>
                    <label for="db_name" class="block text-sm font-medium text-gray-700 mb-1">数据库名</label>
                    <input type="text" name="db_name" id="db_name" 
                           value="{{ db_config.db_name|default:'' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                           placeholder="要操作的数据库名称">
                </div>
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <button type="button" id="testConnection" 
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                    <i class="fa fa-check-circle mr-2"></i> 测试连接
                </button>
                
                <div id="connectionResult" class="hidden"></div>
                
                <button type="submit" 
                        class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                    <i class="fa fa-arrow-right mr-2"></i> 下一步
                </button>
                
                <a href="{% url 'index' %}" 
                   class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                    <i class="fa fa-arrow-left mr-2"></i> 返回
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const testButton = document.getElementById('testConnection');
        const resultDiv = document.getElementById('connectionResult');
        const form = document.getElementById('dbConfigForm');
        
        testButton.addEventListener('click', function() {
            // 显示加载状态
            testButton.disabled = true;
            testButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 测试中...';
            resultDiv.classList.add('hidden');
            
            // 收集表单数据
            const formData = new FormData(form);
            
            // 发送AJAX请求
            fetch("{% url 'check_connection' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                // 显示结果
                resultDiv.classList.remove('hidden');
                resultDiv.className = '';
                
                if (data.status === 'success') {
                    resultDiv.className = 'px-4 py-2 bg-green-50 text-green-800 rounded-md text-sm flex-1';
                    resultDiv.innerHTML = '<i class="fa fa-check-circle mr-1"></i> ' + data.message;
                } else {
                    resultDiv.className = 'px-4 py-2 bg-red-50 text-red-800 rounded-md text-sm flex-1';
                    resultDiv.innerHTML = '<i class="fa fa-exclamation-circle mr-1"></i> ' + data.message;
                }
                
                // 恢复按钮状态
                testButton.disabled = false;
                testButton.innerHTML = '<i class="fa fa-check-circle mr-2"></i> 测试连接';
            })
            .catch(error => {
                // 处理错误
                resultDiv.classList.remove('hidden');
                resultDiv.className = 'px-4 py-2 bg-red-50 text-red-800 rounded-md text-sm flex-1';
                resultDiv.innerHTML = '<i class="fa fa-exclamation-circle mr-1"></i> 测试失败，请重试';
                
                // 恢复按钮状态
                testButton.disabled = false;
                testButton.innerHTML = '<i class="fa fa-check-circle mr-2"></i> 测试连接';
            });
        });
    });
</script>
{% endblock %}
